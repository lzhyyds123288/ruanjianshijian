<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>体育用品销售系统 - 商品管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui-src/dist/css/layui.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        .layui-card { margin: 15px; }
        .search-bar { padding: 15px; background: #f5f5f5; border-radius: 4px; margin-bottom: 15px; }
        .operate-btn { margin-right: 5px; }
        .goods-status { padding: 3px 8px; border-radius: 4px; font-size: 12px; }
        .status-on { background: #e8f4fd; color: #1e9fff; }
        .status-off { background: #fef2f2; color: #ff4d4f; }
        .upload-img { width: 100px; height: 100px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; cursor: pointer; }
        .upload-img img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>
    <!-- 登录检查 -->
    <script>if (!localStorage.getItem('currentUser')) window.location.href = 'login.html';</script>

    <div class="layui-layout layui-layout-admin">
        <!-- 头部导航 -->
        <div class="layui-header">
            <div class="layui-logo"><i class="fa fa-futbol-o"></i> 体育用品销售系统</div>
            <ul class="layui-nav layui-layout-left">
                <li class="layui-nav-item layui-this"><a href="index.html">商品管理</a></li>
                <li class="layui-nav-item"><a href="cart.html">购物车</a></li>
                <li class="layui-nav-item"><a href="orders.html">我的订单</a></li>
            </ul>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item" id="userNav">
                    <a href="javascript:;"><img src="https://picsum.photos/id/1005/200/200" class="layui-nav-img"><span id="username">用户名</span></a>
                    <dl class="layui-nav-child"><dd><a href="javascript:;" id="logout">退出登录</a></dd></dl>
                </li>
            </ul>
        </div>

        <!-- 侧边栏 -->
        <div class="layui-side">
            <div class="layui-side-scroll">
                <ul class="layui-nav layui-nav-tree">
                    <li class="layui-nav-item layui-this">
                        <a href="javascript:;">商品管理</a>
                        <dl class="layui-nav-child"><dd class="layui-this"><a href="index.html">商品列表</a></dd></dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:;">订单管理</a>
                        <dl class="layui-nav-child">
                            <dd><a href="cart.html">购物车</a></dd>
                            <dd><a href="orders.html">我的订单</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="layui-body" style="padding: 15px;">
            <div class="layui-card">
                <div class="layui-card-header">
                    <button class="layui-btn" id="addBtn"><i class="fa fa-plus"></i> 添加商品</button>
                    <button class="layui-btn layui-btn-danger" id="batchDeleteBtn"><i class="fa fa-trash-o"></i> 批量删除</button>
                    <button class="layui-btn layui-btn-primary" id="refreshBtn"><i class="fa fa-refresh"></i> 刷新</button>
                </div>
                <div class="layui-card-body">
                    <!-- 搜索区域 -->
                    <div class="search-bar">
                        <form class="layui-form" lay-filter="searchForm">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">商品名称</label>
                                    <div class="layui-input-inline"><input type="text" name="goodsName" placeholder="请输入商品名称" class="layui-input"></div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">商品分类</label>
                                    <div class="layui-input-inline">
                                        <select name="categoryId">
                                            <option value="">全部分类</option>
                                            <option value="1">球类运动</option>
                                            <option value="2">运动服饰</option>
                                            <option value="3">健身器材</option>
                                            <option value="4">户外装备</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="layui-btn" id="searchBtn"><i class="fa fa-search"></i> 搜索</button>
                                <button type="reset" class="layui-btn layui-btn-primary" id="resetBtn"><i class="fa fa-refresh"></i> 重置</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 商品表格 -->
                    <table class="layui-table" lay-size="sm">
                        <thead><tr>
                            <th><input type="checkbox" lay-skin="primary" lay-filter="checkAll"></th>
                            <th>ID</th>
                            <th>图片</th>
                            <th>商品名称</th>
                            <th>分类</th>
                            <th>价格</th>
                            <th>库存</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                    
                    <!-- 分页 -->
                    <div id="pagination" style="text-align: right;"></div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="layui-footer">© 体育用品销售系统 - 版权所有</div>
    </div>

    <!-- 商品表单弹窗（默认隐藏） -->
    <div id="goodsForm" class="layui-form" style="display: none; padding: 20px;">
        <input type="hidden" name="id">
        <div class="layui-form-item">
            <label class="layui-form-label">商品名称</label>
            <div class="layui-input-block"><input type="text" name="name" lay-verify="required" placeholder="请输入商品名称" class="layui-input"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品分类</label>
            <div class="layui-input-block">
                <select name="categoryId" lay-verify="required">
                    <option value="1">球类运动</option>
                    <option value="2">运动服饰</option>
                    <option value="3">健身器材</option>
                    <option value="4">户外装备</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">价格</label>
            <div class="layui-input-block"><input type="number" name="price" lay-verify="required" placeholder="请输入价格" class="layui-input"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">库存</label>
            <div class="layui-input-block"><input type="number" name="stock" lay-verify="required" placeholder="请输入库存" class="layui-input"></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">商品图片</label>
            <div class="layui-input-block">
                <div class="upload-img" id="uploadImg">
                    <img id="previewImg" src="" style="display: none;">
                    <i class="fa fa-upload"></i>
                </div>
                <input type="hidden" name="imageUrl" id="imageUrl">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <select name="status" lay-verify="required">
                    <option value="1">上架</option>
                    <option value="0">下架</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="saveGoods">保存</button>
                <button type="button" class="layui-btn layui-btn-primary" id="cancelBtn">取消</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui-src/dist/layui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script>
        layui.use(['form', 'layer', 'laypage'], function() {
            const form = layui.form;
            const layer = layui.layer;
            const laypage = layui.laypage;
            let currentPage = 1;
            let pageSize = 5;

            // 初始化商品数据
            if (!localStorage.getItem('goodsData')) {
                localStorage.setItem('goodsData', JSON.stringify([
                    {id: 1, name: '专业比赛篮球', categoryId: 1, categoryName: '球类运动', price: 199, stock: 120, status: 1, imageUrl: 'https://picsum.photos/id/1059/200/200'},
                    {id: 2, name: '专业跑步鞋', categoryId: 2, categoryName: '运动服饰', price: 499, stock: 85, status: 1, imageUrl: 'https://picsum.photos/id/1060/200/200'},
                    {id: 3, name: '专业防滑瑜伽垫', categoryId: 3, categoryName: '健身器材', price: 129, stock: 50, status: 1, imageUrl: 'https://picsum.photos/id/1061/200/200'},
                    {id: 4, name: '专业羽毛球拍', categoryId: 1, categoryName: '球类运动', price: 259, stock: 78, status: 1, imageUrl: 'https://picsum.photos/id/1062/200/200'}
                ]));
            }

            // 加载用户信息
            function loadUserInfo() {
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                $('#username').text(user.username || '用户');
            }

            // 退出登录
            $('#logout').click(() => {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });

            // 数据操作
            const getGoods = () => JSON.parse(localStorage.getItem('goodsData') || '[]');
            const saveGoods = (data) => localStorage.setItem('goodsData', JSON.stringify(data));

            // 渲染商品表格
            function renderTable(data) {
                const tbody = $('table.layui-table tbody').empty();
                if (!data.length) return tbody.html('<tr><td colspan="9" style="text-align:center">暂无数据</td></tr>');
                
                data.forEach(item => {
                    const statusHtml = item.status === 1 ? 
                        '<span class="goods-status status-on">上架</span>' : 
                        '<span class="goods-status status-off">下架</span>';
                    
                    tbody.append(`<tr>
                        <td><input type="checkbox" lay-skin="primary" data-id="${item.id}"></td>
                        <td>${item.id}</td>
                        <td><img src="${item.imageUrl}" style="width:50px;height:50px"></td>
                        <td>${item.name}</td>
                        <td>${item.categoryName}</td>
                        <td>¥${item.price.toFixed(2)}</td>
                        <td>${item.stock}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="layui-btn layui-btn-sm edit-btn" data-id="${item.id}"><i class="fa fa-edit"></i> 编辑</button>
                            <button class="layui-btn layui-btn-sm layui-btn-danger delete-btn" data-id="${item.id}"><i class="fa fa-trash-o"></i> 删除</button>
                            <button class="layui-btn layui-btn-sm ${item.status ? 'layui-btn-warning' : 'layui-btn-normal'} status-btn" data-id="${item.id}" data-status="${item.status ? 0 : 1}">
                                <i class="fa fa-arrow-${item.status ? 'down' : 'up'}"></i> ${item.status ? '下架' : '上架'}
                            </button>
                            <button class="layui-btn layui-btn-sm layui-btn-primary add-to-cart-btn" data-id="${item.id}"><i class="fa fa-shopping-cart"></i> 加入购物车</button>
                        </td>
                    </tr>`);
                });
                form.render('checkbox');
            }

            // 渲染分页
            function renderPagination(total) {
                laypage.render({
                    elem: 'pagination',
                    count: total,
                    limit: pageSize,
                    curr: currentPage,
                    layout: ['prev', 'page', 'next', 'count', 'limit'],
                    limits: [5, 10, 15],
                    jump: (obj, first) => {
                        if (!first) {
                            currentPage = obj.curr;
                            pageSize = obj.limit;
                            loadGoodsData();
                        }
                    }
                });
            }

            // 加载商品数据（带搜索分页）
            function loadGoodsData() {
                const goodsName = $('input[name="goodsName"]').val().trim();
                const categoryId = $('select[name="categoryId"]').val();
                let filtered = getGoods().filter(item => 
                    (!goodsName || item.name.includes(goodsName)) &&
                    (!categoryId || item.categoryId == categoryId)
                );
                
                const start = (currentPage - 1) * pageSize;
                renderTable(filtered.slice(start, start + pageSize));
                renderPagination(filtered.length);
            }

            // 添加商品
            $('#addBtn').click(() => {
                $('#goodsForm')[0].reset();
                $('input[name="id"]').val('');
                $('#previewImg').hide();
                $('#imageUrl').val('');
                layer.open({type: 1, title: '添加商品', content: $('#goodsForm'), area: ['600px', 'auto']});
            });

            // 编辑商品
            $(document).on('click', '.edit-btn', function() {
                const id = $(this).data('id');
                const item = getGoods().find(g => g.id == id);
                if (!item) return;
                
                form.val('goodsForm', {
                    id: item.id,
                    name: item.name,
                    categoryId: item.categoryId,
                    price: item.price,
                    stock: item.stock,
                    status: item.status,
                    imageUrl: item.imageUrl
                });
                item.imageUrl && ($('#previewImg').attr('src', item.imageUrl).show());
                layer.open({type: 1, title: '编辑商品', content: $('#goodsForm'), area: ['600px', 'auto']});
            });

            // 删除商品
            $(document).on('click', '.delete-btn', function() {
                const id = $(this).data('id');
                const item = getGoods().find(g => g.id == id);
                layer.confirm(`确定删除【${item.name}】?`, () => {
                    saveGoods(getGoods().filter(g => g.id != id));
                    loadGoodsData();
                    layer.msg('删除成功');
                });
            });

            // 批量删除
            $('#batchDeleteBtn').click(() => {
                const ids = $('input[type="checkbox"]:checked').map((i, el) => $(el).data('id')).get();
                if (!ids.length) return layer.msg('请选择商品', {icon: 2});
                
                layer.confirm(`确定删除选中的${ids.length}个商品?`, () => {
                    saveGoods(getGoods().filter(g => !ids.includes(g.id)));
                    loadGoodsData();
                    layer.msg('删除成功');
                });
            });

            // 状态切换
            $(document).on('click', '.status-btn', function() {
                const id = $(this).data('id');
                const status = $(this).data('status');
                const goods = getGoods();
                const item = goods.find(g => g.id == id);
                item.status = status;
                saveGoods(goods);
                loadGoodsData();
                layer.msg(`商品已${status ? '上架' : '下架'}`);
            });

            // 图片上传模拟
            $('#uploadImg').click(() => {
                const imgUrl = `https://picsum.photos/id/${1070 + Math.floor(Math.random() * 10)}/200/200`;
                $('#imageUrl').val(imgUrl);
                $('#previewImg').attr('src', imgUrl).show();
            });

            // 保存商品
            form.on('submit(saveGoods)', function(data) {
                const goods = getGoods();
                const field = data.field;
                
                if (field.id) {
                    // 编辑
                    const index = goods.findIndex(g => g.id == field.id);
                    goods[index] = {
                        ...goods[index],
                        ...field,
                        categoryName: $(`select[name="categoryId"] option[value="${field.categoryId}"]`).text(),
                        price: parseFloat(field.price),
                        stock: parseInt(field.stock),
                        status: parseInt(field.status)
                    };
                } else {
                    // 新增
                    const newId = goods.length ? Math.max(...goods.map(g => g.id)) + 1 : 1;
                    goods.unshift({
                        id: newId,
                        ...field,
                        categoryName: $(`select[name="categoryId"] option[value="${field.categoryId}"]`).text(),
                        price: parseFloat(field.price),
                        stock: parseInt(field.stock),
                        status: parseInt(field.status),
                        imageUrl: field.imageUrl || 'https://picsum.photos/id/1000/200/200'
                    });
                }
                
                saveGoods(goods);
                layer.closeAll();
                loadGoodsData();
                layer.msg(field.id ? '编辑成功' : '添加成功');
                return false;
            });

            // 加入购物车
            $(document).on('click', '.add-to-cart-btn', function() {
                const id = $(this).data('id');
                const item = getGoods().find(g => g.id == id);
                if (!item) return layer.msg('商品不存在', {icon: 2});
                
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const cartItem = cart.find(c => c.id == id);
                cartItem ? cartItem.quantity++ : cart.push({...item, quantity: 1});
                
                localStorage.setItem('cart', JSON.stringify(cart));
                layer.msg('已加入购物车');
            });

            // 搜索和重置
            $('#searchBtn').click(() => { currentPage = 1; loadGoodsData(); });
            $('#resetBtn, #refreshBtn').click(() => { 
                $('form[lay-filter="searchForm"]')[0].reset();
                form.render();
                currentPage = 1;
                loadGoodsData();
            });

            // 全选
            form.on('checkbox(checkAll)', function(data) {
                $('table tbody input[type="checkbox"]').prop('checked', data.elem.checked);
                form.render('checkbox');
            });

            // 取消按钮
            $('#cancelBtn').click(() => layer.closeAll());

            // 初始化
            loadUserInfo();
            loadGoodsData();
        });
    </script>
</body>
</html>
